<?xml version="1.0" encoding="utf-8"?>
<components:GCToolWindow xmlns:fx="http://ns.adobe.com/mxml/2009"
						 xmlns:s="library://ns.adobe.com/flex/spark"
						 xmlns:mx="library://ns.adobe.com/flex/mx"
						 xmlns:components="ghostcattools.components.*"
						 width="620" height="488" minWidth="600" minHeight="350"
						 currentState="match" showStatusBar="false" title="正则工具" creationComplete="gctoolwindow1_creationCompleteHandler(event)">
	<fx:Script>
		<![CDATA[
			import flashx.textLayout.events.FlowElementMouseEvent;
			import flashx.textLayout.formats.TextLayoutFormat;
			
			import ghostcat.ui.controls.GText;
			
			import ghostcattools.util.FileControl;
			
			import mx.events.FlexEvent;
			
			import spark.events.IndexChangeEvent;
			import spark.events.TextOperationEvent;
			[Bindable]
			public var helpDatas:ArrayList = new ArrayList([
				". 任意字符",
				"\\w 字母",
				"\\s 空白符号",
				"\\d 数字",
				"\\b 单词边界",
				"\\W 非字母",
				"\\S 非空白符号",
				"\\D 非数字",
				"\\B 非单词边界",
				"\\t 制表符",
				"\\r 回车",
				"\\n 换行",
				"\\xnn ASCII 16进制",
				"\\unnnn Unicode",
				"| 分支",
				"[^x] 非字符x",
				"^ 行首",
				"$ 行尾",
				"* 重复零或更多次",
				"+ 重复一或更多次",
				"? 重复零或一次",
				"{n} 重复n次",
				"{n,} 重复n获更多次",
				"{n,m} 重复n到m次",
				"(exp)	捕获至组",
				"(?<a>exp) 捕获至组a",
				"(?:exp) 跳过组",
				"(?=exp) 之前匹配",
				"(?<=exp) 之后匹配",
				"(?!=exp) 之前不匹配",
				"(?<!=exp) 之后不匹配",
				"(?#comment) 注释",
				"$$ 一个$",
				"$& 匹配的字符",
				"$` 匹配之前的字符",
				"$' 匹配之后的字符",
				"$n 匹配的第n个组"	
			]);
			
			public override function openFileHandler(files:Array):void
			{
				if (!files)
					return;
				
				var file:File = files[0] as File;
				var bytes:ByteArray = FileControl.readFile(file);
				this.sourceText.text = bytes.toString();
			}
				
			protected function helpList_doubleClickHandler(e:Event):void
			{
				var mark:String = helpList.selectedItem.toString().split(" ")[0];
				if (mark.charAt(0) == "$" && mark.length > 1)
				{
					if (replaceText)
					{
						replaceText.insertText(mark);
					}
				}
				else
				{
					regExpText.insertText(mark);
				}
				doExp();
			}

			protected function regExp_changeHandler(event:Event):void
			{
				doExp();
			}
			
			private function doExp():void
			{
				if (regExpText.text == "")
				{
					this.execText.text = "";
					return;
				}
				
				var params:String = (paramg.selected ? "g" : "") + 
					(parami.selected ? "i" : "") + 
					(paramx.selected ? "x" : "") + 
					(params.selected ? "s" : "") + 
					(paramm.selected ? "m" : "");
				var regExp:RegExp = new RegExp(regExpText.text,params);
				
				if (this.currentState == "replace")
					this.targetText.text = this.sourceText.text.replace(regExp,this.replaceText.text);
				
				
				var textLayoutFormat:TextLayoutFormat = new TextLayoutFormat(this.sourceText.textFlow.computedFormat);
				this.sourceText.setFormatOfRange(textLayoutFormat,0,this.sourceText.text.length);
				
				regExp.lastIndex = 0;
				textLayoutFormat.color = 0xFF0000;
				do
				{
					var execResult:Object = regExp.exec(this.sourceText.text);
					if (execResult)
					{
						var index:int = execResult.index;
						var len:int = execResult[0].length;
						this.sourceText.setFormatOfRange(textLayoutFormat,index,index + len);
					}
				}
				while (execResult && regExp.global);
				
				var testResult:String = "表达式写法：/" + regExp.source.replace(/\//g,"\\/") + "/" + params +"\n" +
					"字符串写法：new RegExp(\"" + regExp.source.replace(/\"|\\/g,"\\$&") + "\",\""+ params +"\")\n"
				
				var result:Array = regExp.exec(this.sourceText.text);
				if (result)
				{
					testResult += "匹配了" + result.length + "个组：";
					for (var i:int = 0;i < result.length;i++)
					{
						testResult += "\n(" + (i + 1).toString() + ")" + result[i];
					}
				}
				
				this.execText.text = testResult;
			}


			protected function tabbar1_changeHandler(event:IndexChangeEvent):void
			{
				this.currentState = event.newIndex == 1 ? "replace" : "match";
				doExp();
			}


			protected function gctoolwindow1_creationCompleteHandler(event:FlexEvent):void
			{
				regExpText.setFocus();
				doExp();
			}

		]]>
	</fx:Script>
	<components:states>
		<s:State name="match"/>
		<s:State name="replace"/>
	</components:states>
	<fx:Declarations>
		<!-- 将非可视元素（例如服务、值对象）放在此处 -->
	</fx:Declarations>
	<s:TabBar x="10" y="7" selectedIndex.match="0" selectedIndex.replace="1"
			  change="tabbar1_changeHandler(event)">
		<s:ArrayList>
			<fx:String>match</fx:String>
			<fx:String>replace</fx:String>
		</s:ArrayList>
	</s:TabBar>
	<s:BorderContainer left="10" right="10" top="30" bottom="10">
		<s:TextInput id="regExpText" left="10" right="178" top="10" text="[\d]"
					 change="regExp_changeHandler(event)"/>
		<s:TextInput id="replaceText" includeIn="replace" left="10" right="178" top="69" text="用于替换的文本"
					 change="regExp_changeHandler(event)"/>
		<s:CheckBox id="paramg" x="10" y="40" width="85" label="多次匹配" toolTip="参数：g" change="regExp_changeHandler(event)"/>
		<s:CheckBox id="parami" x="84" y="40" label="忽略大小写" toolTip="参数：i" change="regExp_changeHandler(event)"/>
		<s:CheckBox id="paramx" x="172" y="40" label="忽略空格" toolTip="参数：x" change="regExp_changeHandler(event)"/>
		<s:CheckBox id="params" x="250" y="40" label=".多行有效" toolTip="参数：s" change="regExp_changeHandler(event)"/>
		<s:CheckBox id="paramm" x="328" y="40" label="$^多行有效" toolTip="参数：m" change="regExp_changeHandler(event)"/>
		<s:List id="helpList" right="10" top="10" bottom="10" width="159" dataProvider="{helpDatas}" doubleClickEnabled="true" doubleClick="helpList_doubleClickHandler(event)"/>
		<s:TextArea id="sourceText" left="10" right="178" top="69" bottom="210" text="这是一段测试文本[0]" change="regExp_changeHandler(event)"
					left.match="10" right.match="178" top.match="69" bottom.match="100"
					left.replace="10" right.replace="178" top.replace="99" bottom.replace="210"/>
		<s:TextArea id="targetText" includeIn="replace" left="10" right="178" bottom="101" 
					height="101" editable="false"/>
		<s:TextArea id="execText" left="10" right="178" bottom="10" height="82" editable="false"/>
	</s:BorderContainer>
</components:GCToolWindow>
